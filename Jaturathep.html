<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Jaturathep</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #74ebd5, #acb6e5);
  min-height: 100vh;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}
.container {
  background: white;
  padding: 20px;
  border-radius: 15px;
  width: 100%;
  max-width: 720px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
h1 { text-align: center; }
.top-bar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}
button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.edit-btn { background: #ffb703; }
.add-btn { background: #2a9d8f; color: white; }
.delete-btn { background: #e63946; color: white; }
.reset-btn { background: #e63946; color: white; }

table { width: 100%; border-collapse: collapse; }
th, td { padding: 8px; text-align: center; border-bottom: 1px solid #ddd; }
th { background: #f1f1f1; }

.edit-area { display: none; margin-top: 10px; gap: 5px; }
input { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }

.modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}
.error { color: red; }
</style>
</head>
<body>

<div class="container">
  <h1>Jaturathep</h1>

  <div class="top-bar">
    <div id="counter">สมาชิก 0 / 30</div>
    <button class="edit-btn" id="editModeBtn" onclick="openModal()">เข้าสู่โหมดแก้ไข</button>
    <button class="reset-btn" id="resetBtn" onclick="resetAll()" style="display:none">รีเซ็ต</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ชื่อ</th>
        <th>จำนวนไม้</th>
        <th>จัดการ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="edit-area" id="editArea">
    <input id="nameInput" placeholder="กรอกชื่อ" />
    <button class="add-btn" onclick="addMember()">เพิ่ม</button>
    <button class="add-btn" onclick="saveAndExit()">บันทึก</button>
  </div>
</div>

<div class="modal" id="passwordModal">
  <div class="modal-content">
    <h3>ใส่รหัสผ่าน</h3>
    <input type="password" id="passwordInput" />
    <div class="error" id="errorMsg"></div>
    <button class="add-btn" onclick="confirmPassword()">ยืนยัน</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDsM9ByXHwfxhAG8lBfRKiHSGuxwSiAdls",
  authDomain: "jaturathep-55793.firebaseapp.com",
  databaseURL: "https://jaturathep-55793-default-rtdb.firebaseio.com",
  projectId: "jaturathep-55793",
  storageBucket: "jaturathep-55793.firebasestorage.app",
  messagingSenderId: "681766321980",
  appId: "1:681766321980:web:cea8b2eee2e3196f10e839"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dataRef = ref(db, "members");

const PASSWORD = "jtrt99";
const maxMembers = 30;
let members = [];
let editMode = false;

onValue(dataRef, (snapshot) => {
  members = snapshot.val() || [];
  render();
});

function saveData() {
  if (!editMode) return;
  set(dataRef, members);
}

function openModal() {
  passwordModal.style.display = "flex";
}

function confirmPassword() {
  if (passwordInput.value === PASSWORD) {
    editMode = true;
    sessionStorage.setItem("editMode", "true");
    passwordModal.style.display = "none";
    errorMsg.innerText = "";
    updateEditUI();
  } else {
    errorMsg.innerText = "รหัสผ่านไม่ถูกต้อง";
  }
}

function updateEditUI() {
  editArea.style.display = editMode ? "flex" : "none";
  resetBtn.style.display = editMode ? "inline-block" : "none";
  editModeBtn.style.display = editMode ? "none" : "inline-block";
  render();
}

function addMember() {
  const name = nameInput.value.trim();
  if (!name || members.length >= maxMembers) return;
  members.push({ name, count: 0 });
  nameInput.value = "";
  saveData();
}

function removeMember(i) {
  members.splice(i, 1);
  saveData();
}

function addCount(i) {
  members[i].count++;
  saveData();
}

function resetAll() {
  if (!confirm("รีเซ็ตทั้งหมด?")) return;
  members.forEach(m => m.count = 0);
  saveData();
}

function saveAndExit() {
  saveData();
  editMode = false;
  sessionStorage.removeItem("editMode");
  updateEditUI();
}

function render() {
  tableBody.innerHTML = "";
  members.forEach((m, i) => {
    tableBody.innerHTML += `
      <tr>
        <td>${m.name}</td>
        <td>${m.count}</td>
        <td>${editMode ? `<button class='add-btn' onclick='addCount(${i})'>+</button> <button class='delete-btn' onclick='removeMember(${i})'>ลบ</button>` : "-"}</td>
      </tr>`;
  });
  counter.innerText = `สมาชิก ${members.length} / ${maxMembers}`;
}

// expose functions for HTML
window.openModal = openModal;
window.confirmPassword = confirmPassword;
window.addMember = addMember;
window.removeMember = removeMember;
window.addCount = addCount;
window.resetAll = resetAll;
window.saveAndExit = saveAndExit;

editMode = sessionStorage.getItem("editMode") === "true";
updateEditUI();
</script>

</body>
</html>
