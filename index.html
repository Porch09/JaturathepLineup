<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Jaturathep Lineup</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:20px;
  }
  .container {
    max-width:600px;
    margin:auto;
    background:#fff;
    padding:20px;
    border-radius:8px;
  }
  h1 { text-align:center; }
  table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
  }
  th, td {
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
  }
  button {
    padding:5px 10px;
    margin:2px;
    cursor:pointer;
  }
  .add-btn { background:#4caf50; color:#fff; border:none; }
  .delete-btn { background:#f44336; color:#fff; border:none; }
  #editArea { display:none; margin-top:10px; }
  #passwordModal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    justify-content:center;
    align-items:center;
  }
  #passwordModal .box {
    background:#fff;
    padding:20px;
    border-radius:6px;
    width:250px;
  }
  #errorMsg { color:red; font-size:14px; }
</style>
</head>

<body>
<div class="container">
  <h1>Jaturathep</h1>

  <button id="editModeBtn" onclick="openModal()">เข้าสู่โหมดแก้ไข</button>
  <button id="resetBtn" onclick="resetAll()" style="display:none;">รีเซ็ต</button>

  <div id="editArea">
    <input id="nameInput" placeholder="ชื่อสมาชิก"/>
    <button onclick="addMember()">เพิ่ม</button>
    <button onclick="saveAndExit()">บันทึก & ออก</button>
  </div>

  <div id="counter"></div>

  <table>
    <thead>
      <tr>
        <th>ชื่อ</th>
        <th>จำนวน</th>
        <th>จัดการ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- modal -->
<div id="passwordModal">
  <div class="box">
    <h3>ใส่รหัสผ่าน</h3>
    <input id="passwordInput" type="password"/>
    <button onclick="confirmPassword()">ตกลง</button>
    <div id="errorMsg"></div>
  </div>
</div>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDsM9ByXHwfxhAG8lBfRKiHSGuxwSiAdls",
  authDomain: "jaturathep-55793.firebaseapp.com",
  databaseURL: "https://jaturathep-55793-default-rtdb.firebaseio.com",
  projectId: "jaturathep-55793",
  storageBucket: "jaturathep-55793.firebasestorage.app",
  messagingSenderId: "681766321980",
  appId: "1:681766321980:web:cea8b2eee2e3196f10e839"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dataRef = ref(db, "members");

/* ตัวแปร */
const PASSWORD = "jtrt99";
const maxMembers = 30;

let members = [];
let editMode = false;

/* DOM */
const tableBody = document.getElementById("tableBody");
const counter = document.getElementById("counter");
const editArea = document.getElementById("editArea");
const resetBtn = document.getElementById("resetBtn");
const editModeBtn = document.getElementById("editModeBtn");
const passwordModal = document.getElementById("passwordModal");
const passwordInput = document.getElementById("passwordInput");
const errorMsg = document.getElementById("errorMsg");
const nameInput = document.getElementById("nameInput");

/* โหลดข้อมูล realtime */
onValue(dataRef, snap => {
  members = snap.val() || [];
  render();
});

/* ฟังก์ชัน */
function saveData() {
  if (!editMode) return;
  set(dataRef, members);
}

function render() {
  tableBody.innerHTML = "";
  members.forEach((m,i) => {
    tableBody.innerHTML += `
      <tr>
        <td>${m.name}</td>
        <td>${m.count}</td>
        <td>
          ${editMode
            ? `<button class="add-btn" onclick="addCount(${i})">+</button>
               <button class="delete-btn" onclick="removeMember(${i})">ลบ</button>`
            : "-"}
        </td>
      </tr>`;
  });
  counter.innerText = `สมาชิก ${members.length} / ${maxMembers}`;
}

/* expose ให้ HTML */
window.openModal = () => passwordModal.style.display = "flex";

window.confirmPassword = () => {
  if (passwordInput.value === PASSWORD) {
    editMode = true;
    sessionStorage.setItem("editMode","true");
    passwordModal.style.display = "none";
    errorMsg.innerText = "";
    updateEditUI();
  } else {
    errorMsg.innerText = "รหัสผ่านไม่ถูกต้อง";
  }
};

window.updateEditUI = () => {
  editArea.style.display = editMode ? "block" : "none";
  resetBtn.style.display = editMode ? "inline-block" : "none";
  editModeBtn.style.display = editMode ? "none" : "inline-block";
  render();
};

window.addMember = () => {
  const name = nameInput.value.trim();
  if (!name || members.length >= maxMembers) return;
  members.push({ name, count:0 });
  nameInput.value = "";
  saveData();
};

window.removeMember = i => {
  members.splice(i,1);
  saveData();
};

window.addCount = i => {
  members[i].count++;
  saveData();
};

window.resetAll = () => {
  if (!confirm("รีเซ็ตทั้งหมด?")) return;
  members.forEach(m => m.count = 0);
  saveData();
};

window.saveAndExit = () => {
  saveData();
  editMode = false;
  sessionStorage.removeItem("editMode");
  updateEditUI();
};

/* init */
editMode = sessionStorage.getItem("editMode") === "true";
updateEditUI();

});
</script>
</body>
</html>
